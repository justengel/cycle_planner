<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Cycle Planner{% endblock %}</title>
    <link rel="icon" type="image/svg+xml" href="/static/favicon.svg">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <link rel="stylesheet" href="/static/css/print.css" media="print">
    <style>
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <nav class="bg-indigo-600 text-white shadow-lg print:hidden">
        <div class="max-w-6xl mx-auto px-4 py-3 flex justify-between items-center">
            <a href="/" class="text-xl font-bold">Cycle Planner</a>
            <div class="flex items-center space-x-4">
                <span id="auth-nav-links">
                    <a href="/" class="hover:text-indigo-200">Generator</a>
                    <a href="/plans" class="hover:text-indigo-200 ml-4">My Plans</a>
                </span>
                <span id="spotify-status"></span>
                <span id="auth-status"></span>
            </div>
        </div>
    </nav>

    <main class="max-w-6xl mx-auto px-4 py-8">
        {% block content %}{% endblock %}
    </main>

    <footer class="text-center text-gray-500 text-sm py-4 print:hidden">
        <p class="mb-1">&copy; 2025 Cycle Planner</p>
        <p>Music powered by <a href="https://spotify.com" target="_blank" rel="noopener" class="text-indigo-600 hover:underline">Spotify</a> | BPM data from <a href="https://getsongbpm.com" target="_blank" rel="dofollow" class="text-indigo-600 hover:underline">GetSongBPM</a></p>
    </footer>

    <!-- Toast Notification Container -->
    <div id="toast-container" class="fixed top-4 right-4 z-50 space-y-2 print:hidden"></div>

    <script>
        function showToast(message, type = 'success') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');

            const bgColor = type === 'success' ? 'bg-green-500' :
                           type === 'error' ? 'bg-red-500' :
                           type === 'warning' ? 'bg-yellow-500' : 'bg-blue-500';

            toast.className = `${bgColor} text-white px-6 py-3 rounded-lg shadow-lg transform transition-all duration-300 translate-x-full`;
            toast.textContent = message;

            container.appendChild(toast);

            // Animate in
            requestAnimationFrame(() => {
                toast.classList.remove('translate-x-full');
            });

            // Auto remove after 3 seconds
            setTimeout(() => {
                toast.classList.add('translate-x-full', 'opacity-0');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // Check Spotify connection status
        async function checkSpotifyStatus() {
            const statusEl = document.getElementById('spotify-status');
            if (!statusEl) return;

            try {
                const response = await fetch('/api/spotify/token');
                const data = await response.json();

                if (data.connected) {
                    statusEl.innerHTML = `
                        <div class="flex items-center gap-2">
                            <span class="flex items-center text-green-300 text-sm">
                                <svg class="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 24 24">
                                    <path d="M12 0C5.4 0 0 5.4 0 12s5.4 12 12 12 12-5.4 12-12S18.66 0 12 0zm5.521 17.34c-.24.359-.66.48-1.021.24-2.82-1.74-6.36-2.101-10.561-1.141-.418.122-.779-.179-.899-.539-.12-.421.18-.78.54-.9 4.56-1.021 8.52-.6 11.64 1.32.42.18.479.659.301 1.02zm1.44-3.3c-.301.42-.841.6-1.262.3-3.239-1.98-8.159-2.58-11.939-1.38-.479.12-1.02-.12-1.14-.6-.12-.48.12-1.021.6-1.141C9.6 9.9 15 10.561 18.72 12.84c.361.181.54.78.241 1.2zm.12-3.36C15.24 8.4 8.82 8.16 5.16 9.301c-.6.179-1.2-.181-1.38-.721-.18-.601.18-1.2.72-1.381 4.26-1.26 11.28-1.02 15.721 1.621.539.3.719 1.02.419 1.56-.299.421-1.02.599-1.559.3z"/>
                                </svg>
                                Spotify
                            </span>
                            <button onclick="disconnectSpotify()" class="text-xs text-indigo-200 hover:text-white underline">
                                Disconnect
                            </button>
                        </div>
                    `;
                } else {
                    statusEl.innerHTML = `
                        <a href="/api/spotify/login" class="flex items-center bg-green-500 hover:bg-green-600 text-white px-3 py-1 rounded-full text-sm">
                            <svg class="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M12 0C5.4 0 0 5.4 0 12s5.4 12 12 12 12-5.4 12-12S18.66 0 12 0zm5.521 17.34c-.24.359-.66.48-1.021.24-2.82-1.74-6.36-2.101-10.561-1.141-.418.122-.779-.179-.899-.539-.12-.421.18-.78.54-.9 4.56-1.021 8.52-.6 11.64 1.32.42.18.479.659.301 1.02zm1.44-3.3c-.301.42-.841.6-1.262.3-3.239-1.98-8.159-2.58-11.939-1.38-.479.12-1.02-.12-1.14-.6-.12-.48.12-1.021.6-1.141C9.6 9.9 15 10.561 18.72 12.84c.361.181.54.78.241 1.2zm.12-3.36C15.24 8.4 8.82 8.16 5.16 9.301c-.6.179-1.2-.181-1.38-.721-.18-.601.18-1.2.72-1.381 4.26-1.26 11.28-1.02 15.721 1.621.539.3.719 1.02.419 1.56-.299.421-1.02.599-1.559.3z"/>
                            </svg>
                            Connect Spotify
                        </a>
                    `;
                }
            } catch (error) {
                console.error('Failed to check Spotify status:', error);
            }
        }

        checkSpotifyStatus();

        async function disconnectSpotify() {
            try {
                await fetch('/api/spotify/logout', { method: 'POST' });
                showToast('Spotify disconnected');
                checkSpotifyStatus();
            } catch (error) {
                showToast('Failed to disconnect', 'error');
            }
        }

        // Check auth status - returns auth data for child pages to use
        let authData = null;
        let authPromise = null;

        async function checkAuthStatus() {
            const authEl = document.getElementById('auth-status');
            const navLinks = document.getElementById('auth-nav-links');
            if (!authEl) return null;

            try {
                const response = await fetch('/api/auth/me');
                authData = await response.json();

                if (authData.authenticated) {
                    navLinks.innerHTML = `
                        <a href="/" class="hover:text-indigo-200">Generator</a>
                        <a href="/plans" class="hover:text-indigo-200 ml-4">My Plans</a>
                    `;
                    authEl.innerHTML = `
                        <span class="text-indigo-200 text-sm mr-2">${authData.email}</span>
                        <button onclick="logout()" class="text-sm bg-indigo-500 hover:bg-indigo-400 px-3 py-1 rounded">
                            Logout
                        </button>
                    `;
                } else {
                    navLinks.innerHTML = '';
                    authEl.innerHTML = `
                        <a href="/login" class="text-sm bg-white text-indigo-600 hover:bg-indigo-100 px-3 py-1 rounded font-medium">
                            Log In
                        </a>
                    `;
                }
                return authData;
            } catch (error) {
                console.error('Failed to check auth status:', error);
                return null;
            }
        }

        // Get auth status (waits for initial check if needed)
        function getAuthStatus() {
            if (authData !== null) return Promise.resolve(authData);
            return authPromise;
        }

        async function logout() {
            try {
                await fetch('/api/auth/logout', { method: 'POST' });
                window.location.href = '/login';
            } catch (error) {
                console.error('Logout failed:', error);
            }
        }

        authPromise = checkAuthStatus();
    </script>

    {% block scripts %}{% endblock %}
</body>
</html>
