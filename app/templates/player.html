{% extends "base.html" %}

{% block title %}Play Class - Cycle Planner{% endblock %}

{% block content %}
<div id="player-container" class="max-w-4xl mx-auto">
    <!-- Loading State -->
    <div id="loading-state" class="text-center py-12">
        <div class="loader mx-auto mb-4"></div>
        <p class="text-gray-600">Loading class...</p>
    </div>

    <!-- Player UI (hidden until loaded) -->
    <div id="player-ui" class="hidden space-y-6">
        <!-- Header -->
        <div class="bg-white rounded-lg shadow-md p-4 sm:p-6">
            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-2">
                <div class="min-w-0 flex-1">
                    <div class="flex items-center gap-3">
                        <h1 id="class-theme" class="text-lg sm:text-2xl font-bold text-gray-800 truncate"></h1>
                        <a id="back-link" href="#" class="text-sm text-gray-600 hover:text-gray-800 whitespace-nowrap">&larr; Back</a>
                    </div>
                    <p id="class-duration" class="text-sm text-gray-600"></p>
                </div>
                <div class="flex flex-col sm:flex-row items-start sm:items-center gap-2 sm:gap-3">
                    <label class="flex items-center gap-1.5 cursor-pointer" title="Play beeps at 10 seconds and 3-2-1 countdown before transitions">
                        <input type="checkbox" id="audio-cues-toggle" class="w-4 h-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500" onchange="toggleAudioCues()">
                        <span class="text-xs text-gray-600">Countdown Beeps</span>
                    </label>
                    <div id="mode-switcher" class="hidden">
                        <div class="flex rounded-lg overflow-hidden border border-gray-300">
                            <button id="spotify-mode-btn" onclick="switchToSpotifyMode()" class="px-3 py-1.5 text-xs font-medium bg-green-500 text-white flex items-center gap-1">
                                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24"><path d="M12 0C5.4 0 0 5.4 0 12s5.4 12 12 12 12-5.4 12-12S18.66 0 12 0zm5.521 17.34c-.24.359-.66.48-1.021.24-2.82-1.74-6.36-2.101-10.561-1.141-.418.122-.779-.179-.899-.539-.12-.421.18-.78.54-.9 4.56-1.021 8.52-.6 11.64 1.32.42.18.479.659.301 1.02zm1.44-3.3c-.301.42-.841.6-1.262.3-3.239-1.98-8.159-2.58-11.939-1.38-.479.12-1.02-.12-1.14-.6-.12-.48.12-1.021.6-1.141C9.6 9.9 15 10.561 18.72 12.84c.361.181.54.78.241 1.2zm.12-3.36C15.24 8.4 8.82 8.16 5.16 9.301c-.6.179-1.2-.181-1.38-.721-.18-.601.18-1.2.72-1.381 4.26-1.26 11.28-1.02 15.721 1.621.539.3.719 1.02.419 1.56-.299.421-1.02.599-1.559.3z"/></svg>
                                Play Spotify
                            </button>
                            <button id="timer-mode-btn" onclick="switchToTimerMode()" class="px-3 py-1.5 text-xs font-medium bg-gray-100 text-gray-600 flex items-center gap-1 hover:bg-gray-200">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                                Timer Only
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Timer Display -->
        <div class="bg-gradient-to-br from-indigo-600 to-purple-700 rounded-lg shadow-lg p-6 sm:p-8 text-white">
            <!-- Segment Title (always shown) -->
            <div id="segment-title" class="text-xl sm:text-2xl font-bold text-center mb-1 opacity-95"></div>
            <div id="segment-cues" class="text-sm sm:text-base text-center opacity-80 mb-4 max-w-2xl mx-auto"></div>

            <!-- Badges (for segment without sub-segments) - shown above timer -->
            <div id="segment-badges" class="flex justify-center items-center gap-3 mb-4">
                <span id="segment-intensity" class="px-3 py-1 rounded-full text-sm bg-white bg-opacity-20"></span>
                <span id="segment-position" class="px-3 py-1 rounded-full text-sm bg-white bg-opacity-20"></span>
                <span id="segment-bpm" class="px-3 py-1 rounded-full text-sm bg-white bg-opacity-20"></span>
            </div>

            <!-- Sub-segment indicator (shown when active) -->
            <div id="sub-segment-info" class="hidden mb-4">
                <div class="bg-white bg-opacity-25 rounded-lg px-5 py-4">
                    <div class="text-xs uppercase tracking-wide opacity-75 mb-2 text-center">Current Activity</div>
                    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2">
                        <div id="sub-segment-name" class="text-xl sm:text-2xl font-bold"></div>
                        <div class="flex items-center gap-2">
                            <span id="sub-segment-intensity" class="px-3 py-1 rounded text-sm font-medium bg-white bg-opacity-25"></span>
                            <span id="sub-segment-position" class="px-3 py-1 rounded text-sm font-medium bg-white bg-opacity-25"></span>
                            <span id="sub-segment-bpm" class="px-3 py-1 rounded text-sm font-medium bg-purple-100 text-purple-800 hidden"></span>
                        </div>
                    </div>
                    <div id="sub-segment-cues" class="text-base sm:text-lg opacity-90 mt-3 text-center"></div>
                </div>
            </div>

            <!-- Timer -->
            <div id="segment-timer" class="text-7xl sm:text-8xl font-bold font-mono text-center mb-4">0:00</div>

            <!-- Progress Bar -->
            <div id="segment-progress" class="w-full bg-white bg-opacity-30 rounded-full h-3 mb-6 cursor-pointer" onclick="seekToPosition(event)" title="Click to seek">
                <div id="segment-progress-bar" class="bg-white rounded-full h-3 transition-all duration-1000 pointer-events-none" style="width: 0%"></div>
            </div>

            <!-- Controls -->
            <div class="flex justify-center items-center gap-3 sm:gap-4 mb-4">
                <button onclick="previousSegment()" class="p-2 sm:p-3 rounded-full hover:bg-white hover:bg-opacity-20 transition-colors" title="Previous">
                    <svg class="w-6 h-6 sm:w-8 sm:h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12.066 11.2a1 1 0 000 1.6l5.334 4A1 1 0 0019 16V8a1 1 0 00-1.6-.8l-5.333 4zM4.066 11.2a1 1 0 000 1.6l5.334 4A1 1 0 0011 16V8a1 1 0 00-1.6-.8l-5.334 4z"/>
                    </svg>
                </button>

                <button onclick="skipTime(-10)" class="p-2 rounded-full hover:bg-white hover:bg-opacity-20 transition-colors" title="Rewind 10s">
                    <svg class="w-5 h-5 sm:w-6 sm:h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12.066 11.2a1 1 0 000 1.6l5.334 4A1 1 0 0019 16V8a1 1 0 00-1.6-.8l-5.333 4z"/>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 12a8 8 0 018-8v4l-4-4 4-4v4a8 8 0 11-8 8"/>
                    </svg>
                </button>

                <button id="play-pause-btn" onclick="togglePlayPause()" class="p-3 sm:p-4 bg-white bg-opacity-20 rounded-full hover:bg-opacity-30 transition-colors">
                    <svg id="play-icon" class="w-8 h-8 sm:w-10 sm:h-10" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"/>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                    <svg id="pause-icon" class="w-8 h-8 sm:w-10 sm:h-10 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 9v6m4-6v6m7-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                </button>

                <button onclick="skipTime(10)" class="p-2 rounded-full hover:bg-white hover:bg-opacity-20 transition-colors" title="Forward 10s">
                    <svg class="w-5 h-5 sm:w-6 sm:h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.933 12.8a1 1 0 000-1.6L6.6 7.2A1 1 0 005 8v8a1 1 0 001.6.8l5.333-4z"/>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12a8 8 0 01-8 8v-4l4 4-4 4v-4a8 8 0 118-8"/>
                    </svg>
                </button>

                <button onclick="nextSegment()" class="p-2 sm:p-3 rounded-full hover:bg-white hover:bg-opacity-20 transition-colors" title="Next">
                    <svg class="w-6 h-6 sm:w-8 sm:h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.933 12.8a1 1 0 000-1.6L6.6 7.2A1 1 0 005 8v8a1 1 0 001.6.8l5.333-4zM19.933 12.8a1 1 0 000-1.6l-5.333-4A1 1 0 0013 8v8a1 1 0 001.6.8l5.333-4z"/>
                    </svg>
                </button>
            </div>

            <!-- Volume -->
            <div class="flex items-center justify-center gap-3">
                <svg class="w-5 h-5 opacity-70" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z"/>
                </svg>
                <input type="range" id="volume-slider" min="0" max="100" value="70" class="w-24 sm:w-32 accent-white" onchange="setVolume(this.value)">
            </div>

            <!-- Now Playing (inside timer box) -->
            <div id="now-playing-inline" class="hidden mt-4 pt-4 border-t border-white border-opacity-20">
                <div class="flex items-center justify-center gap-3">
                    <div id="track-image-inline" class="w-10 h-10 bg-white bg-opacity-20 rounded flex-shrink-0"></div>
                    <div class="text-center">
                        <p id="track-name-inline" class="text-sm font-medium"></p>
                        <p id="track-artist-inline" class="text-xs opacity-70"></p>
                    </div>
                    <svg id="spotify-icon-inline" class="w-5 h-5 text-green-400 flex-shrink-0" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M12 0C5.4 0 0 5.4 0 12s5.4 12 12 12 12-5.4 12-12S18.66 0 12 0zm5.521 17.34c-.24.359-.66.48-1.021.24-2.82-1.74-6.36-2.101-10.561-1.141-.418.122-.779-.179-.899-.539-.12-.421.18-.78.54-.9 4.56-1.021 8.52-.6 11.64 1.32.42.18.479.659.301 1.02zm1.44-3.3c-.301.42-.841.6-1.262.3-3.239-1.98-8.159-2.58-11.939-1.38-.479.12-1.02-.12-1.14-.6-.12-.48.12-1.021.6-1.141C9.6 9.9 15 10.561 18.72 12.84c.361.181.54.78.241 1.2zm.12-3.36C15.24 8.4 8.82 8.16 5.16 9.301c-.6.179-1.2-.181-1.38-.721-.18-.601.18-1.2.72-1.381 4.26-1.26 11.28-1.02 15.721 1.621.539.3.719 1.02.419 1.56-.299.421-1.02.599-1.559.3z"/>
                    </svg>
                </div>
                <!-- Song Position Bar -->
                <div id="song-position-container" class="hidden mt-3 px-4">
                    <div class="flex items-center gap-2 text-xs opacity-70">
                        <span id="song-current-time">0:00</span>
                        <div class="flex-1 bg-white bg-opacity-30 rounded-full h-1.5 cursor-pointer" onclick="seekSongPosition(event)">
                            <div id="song-position-bar" class="bg-green-400 rounded-full h-1.5 transition-all" style="width: 0%"></div>
                        </div>
                        <span id="song-total-time">0:00</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Up Next Preview -->
        <div id="up-next" class="bg-amber-50 border border-amber-200 rounded-lg shadow-md p-4 hidden">
            <div class="flex flex-col sm:flex-row sm:items-start sm:justify-between gap-2 sm:gap-3">
                <div class="flex-1 min-w-0">
                    <div class="flex items-center gap-2 mb-1">
                        <span class="text-xs font-semibold text-amber-600 uppercase tracking-wide">Up Next</span>
                        <span id="up-next-countdown" class="text-xs text-amber-500"></span>
                    </div>
                    <div class="flex items-center gap-2">
                        <p id="up-next-name" class="font-medium text-gray-800"></p>
                        <span id="up-next-duration" class="text-xs text-gray-500 flex-shrink-0"></span>
                    </div>
                </div>
                <div class="flex items-center gap-2 flex-wrap">
                    <span id="up-next-intensity" class="px-2 py-0.5 rounded text-xs bg-gray-200"></span>
                    <span id="up-next-position" class="px-2 py-0.5 rounded text-xs bg-gray-200"></span>
                    <span id="up-next-bpm" class="px-2 py-0.5 rounded text-xs bg-gray-200"></span>
                </div>
            </div>
            <p id="up-next-cues" class="text-sm text-gray-600 mt-2 line-clamp-2"></p>
        </div>

        <!-- All Segments -->
        <div class="bg-white rounded-lg shadow-md p-6">
            <h3 class="font-semibold text-gray-800 mb-3">Segments</h3>
            <div id="all-segments" class="space-y-2"></div>
        </div>
    </div>

    <!-- Spotify Not Connected -->
    <div id="spotify-required" class="hidden text-center py-12">
        <div class="bg-white rounded-lg shadow-md p-8 max-w-md mx-auto">
            <svg class="mx-auto h-16 w-16 text-green-500 mb-4" fill="currentColor" viewBox="0 0 24 24">
                <path d="M12 0C5.4 0 0 5.4 0 12s5.4 12 12 12 12-5.4 12-12S18.66 0 12 0zm5.521 17.34c-.24.359-.66.48-1.021.24-2.82-1.74-6.36-2.101-10.561-1.141-.418.122-.779-.179-.899-.539-.12-.421.18-.78.54-.9 4.56-1.021 8.52-.6 11.64 1.32.42.18.479.659.301 1.02zm1.44-3.3c-.301.42-.841.6-1.262.3-3.239-1.98-8.159-2.58-11.939-1.38-.479.12-1.02-.12-1.14-.6-.12-.48.12-1.021.6-1.141C9.6 9.9 15 10.561 18.72 12.84c.361.181.54.78.241 1.2zm.12-3.36C15.24 8.4 8.82 8.16 5.16 9.301c-.6.179-1.2-.181-1.38-.721-.18-.601.18-1.2.72-1.381 4.26-1.26 11.28-1.02 15.721 1.621.539.3.719 1.02.419 1.56-.299.421-1.02.599-1.559.3z"/>
            </svg>
            <h2 class="text-xl font-bold text-gray-800 mb-2">Spotify Premium Required</h2>
            <p class="text-gray-600 mb-6">Connect your Spotify Premium account to play music during your class.</p>
            <a href="/api/spotify/login" class="inline-block bg-green-500 text-white px-6 py-3 rounded-full hover:bg-green-600 font-medium">
                Connect Spotify
            </a>
            <p class="mt-4 text-sm text-gray-500">
                Or <a id="timer-only-link" href="#" class="text-indigo-600 hover:underline" onclick="startTimerOnly()">use timer only</a> (no music)
            </p>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- Spotify Web Playback SDK -->
<script src="https://sdk.scdn.co/spotify-player.js"></script>

<!-- Player JavaScript modules -->
<script src="{{ url_for('static', path='js/player_state.js') }}"></script>
<script src="{{ url_for('static', path='js/player_ui.js') }}"></script>
<script src="{{ url_for('static', path='js/player_audio_cues.js') }}"></script>
<script src="{{ url_for('static', path='js/player_spotify.js') }}"></script>
<script src="{{ url_for('static', path='js/player_segments.js') }}"></script>
<script src="{{ url_for('static', path='js/player_timer.js') }}"></script>
<script src="{{ url_for('static', path='js/player_init.js') }}"></script>
{% endblock %}
