{% extends "base.html" %}

{% block title %}View Plan - Cycle Planner{% endblock %}

{% block content %}
<div id="plan-view" class="space-y-6">
    <!-- Header -->
    <div class="bg-white rounded-lg shadow-md p-6">
        <div class="flex flex-col sm:flex-row justify-between items-start gap-4">
            <div>
                <h1 id="plan-theme" class="text-2xl font-bold text-gray-800">Loading...</h1>
                <p id="plan-duration" class="text-gray-600 mt-1"></p>
            </div>
            <div class="flex flex-wrap gap-2 print:hidden">
                <button onclick="window.print()" class="bg-gray-100 text-gray-700 px-4 py-2 rounded-md hover:bg-gray-200 text-sm">
                    Print
                </button>
                <a id="edit-link" href="#" class="inline-block bg-indigo-600 text-white px-4 py-2 rounded-md hover:bg-indigo-700 text-sm">
                    Edit
                </a>
                <button id="spotify-playlist-btn" onclick="saveToSpotify()" class="bg-[#1DB954] text-white px-4 py-2 rounded-md hover:bg-[#1ed760] hidden text-sm">
                    Save Playlist
                </button>
                <a id="play-link" href="#" class="inline-block bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700 text-sm">
                    Start
                </a>
            </div>
        </div>
        <!-- Notes -->
        <div id="notes-section" class="mt-4 pt-4 border-t border-gray-200 hidden">
            <h2 class="text-sm font-semibold text-gray-600 mb-1">Notes</h2>
            <p id="plan-notes" class="text-gray-700 whitespace-pre-wrap"></p>
        </div>
    </div>

    <!-- Segments -->
    <div class="bg-white rounded-lg shadow-md p-6">
        <h2 class="text-xl font-bold text-gray-800 mb-4">Segments</h2>
        <div id="segments-list" class="space-y-3">
            <p class="text-gray-500">Loading segments...</p>
        </div>
    </div>

    <!-- Actions -->
    <div class="flex justify-between items-center print:hidden">
        <a href="/plans" class="text-gray-600 hover:text-gray-800">
            &larr; Back to My Plans
        </a>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    const planId = window.location.pathname.split('/').pop();
    let hasSpotifyTracks = false;

    async function loadPlan() {
        try {
            const response = await fetch(`/api/plans/${planId}`, {
                headers: { 'Authorization': 'Bearer placeholder' }
            });

            if (!response.ok) {
                throw new Error('Plan not found');
            }

            const data = await response.json();
            renderPlan(data.plan_json);
            document.getElementById('edit-link').href = `/plan/${planId}/edit`;
            document.getElementById('play-link').href = `/play/${planId}`;

            // Check if plan has Spotify tracks
            hasSpotifyTracks = data.plan_json.segments?.some(s => s.spotify_uri);
            checkSpotifyConnection();

        } catch (error) {
            showToast('Error loading plan: ' + error.message, 'error');
            setTimeout(() => window.location.href = '/plans', 1500);
        }
    }

    async function checkSpotifyConnection() {
        if (!hasSpotifyTracks) return;

        try {
            const response = await fetch('/api/spotify/token');
            const data = await response.json();
            if (data.connected) {
                document.getElementById('spotify-playlist-btn').classList.remove('hidden');
            }
        } catch (error) {
            console.log('Spotify not connected');
        }
    }

    async function saveToSpotify() {
        const btn = document.getElementById('spotify-playlist-btn');
        const originalText = btn.textContent;
        btn.disabled = true;
        btn.textContent = 'Creating...';

        try {
            const response = await fetch('/api/spotify/create-playlist', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ plan_id: planId, public: false })
            });

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.detail || 'Failed to create playlist');
            }

            const data = await response.json();
            showToast(`Playlist "${data.name}" created with ${data.tracks_added} tracks!`, 'success');

            // Open playlist in new tab
            window.open(data.playlist_url, '_blank');

        } catch (error) {
            showToast('Error: ' + error.message, 'error');
        } finally {
            btn.disabled = false;
            btn.textContent = originalText;
        }
    }

    function renderPlan(plan) {
        document.getElementById('plan-theme').textContent = plan.theme || 'Untitled Plan';
        document.getElementById('plan-duration').textContent = `${plan.total_duration_minutes} minutes`;

        // Render segments
        const container = document.getElementById('segments-list');
        let runningTime = 0;

        container.innerHTML = plan.segments.map((segment, i) => {
            const startTime = formatTime(runningTime);
            runningTime += segment.duration_seconds;
            const endTime = formatTime(runningTime);

            const intensityColor = segment.intensity === 'high' ? 'bg-red-100 text-red-800' :
                                   segment.intensity === 'medium' ? 'bg-yellow-100 text-yellow-800' :
                                   'bg-green-100 text-green-800';

            const hasSubSegments = segment.sub_segments && segment.sub_segments.length > 0;

            let subSegmentsHtml = '';
            if (hasSubSegments) {
                let subRunningTime = 0;
                subSegmentsHtml = `
                    <div class="mt-3 ml-4 border-l-2 border-indigo-200 pl-4 space-y-2">
                        <p class="text-xs font-semibold text-indigo-600 uppercase tracking-wide">Sub-segments (${segment.sub_segments.length})</p>
                        ${segment.sub_segments.map((sub, j) => {
                            const subStart = formatTime(subRunningTime);
                            subRunningTime += sub.duration_seconds;
                            const subEnd = formatTime(subRunningTime);

                            const subIntensityColor = sub.intensity === 'high' ? 'bg-red-100 text-red-800' :
                                                      sub.intensity === 'medium' ? 'bg-yellow-100 text-yellow-800' :
                                                      'bg-green-100 text-green-800';

                            return `
                                <div class="bg-white rounded p-3 border border-gray-200">
                                    <div class="flex justify-between items-start mb-1">
                                        <div>
                                            <span class="font-medium text-gray-800 text-sm">${escapeHtml(sub.name)}</span>
                                            <span class="text-xs text-gray-500 ml-2">${subStart} - ${subEnd} (${Math.floor(sub.duration_seconds / 60)}:${(sub.duration_seconds % 60).toString().padStart(2, '0')})</span>
                                        </div>
                                        <div class="flex gap-1">
                                            <span class="px-1.5 py-0.5 rounded text-xs font-medium ${subIntensityColor}">${sub.intensity}</span>
                                            <span class="px-1.5 py-0.5 rounded text-xs font-medium bg-blue-100 text-blue-800">${sub.position}</span>
                                            ${sub.suggested_bpm_range ? `<span class="px-1.5 py-0.5 rounded text-xs font-medium bg-purple-100 text-purple-800">${escapeHtml(sub.suggested_bpm_range)}</span>` : ''}
                                        </div>
                                    </div>
                                    ${sub.description ? `<p class="text-gray-600 text-xs">${escapeHtml(sub.description)}</p>` : ''}
                                </div>
                            `;
                        }).join('')}
                    </div>
                `;
            }

            return `
                <div class="border rounded-lg p-4 ${i % 2 === 0 ? 'bg-gray-50' : 'bg-white'}">
                    <div class="flex justify-between items-start mb-2">
                        <div>
                            <h3 class="font-semibold text-gray-800">${escapeHtml(segment.name)}</h3>
                            <p class="text-sm text-gray-500">${startTime} - ${endTime} (${Math.floor(segment.duration_seconds / 60)}:${(segment.duration_seconds % 60).toString().padStart(2, '0')})</p>
                        </div>
                        <div class="flex gap-2">
                            <span class="px-2 py-1 rounded text-xs font-medium ${intensityColor}">
                                ${segment.intensity}
                            </span>
                            <span class="px-2 py-1 rounded text-xs font-medium bg-blue-100 text-blue-800">
                                ${segment.position}
                            </span>
                            ${segment.suggested_bpm_range ? `<span class="px-2 py-1 rounded text-xs font-medium bg-purple-100 text-purple-800">${escapeHtml(segment.suggested_bpm_range)}</span>` : ''}
                        </div>
                    </div>
                    ${segment.song ? `<p class="text-sm text-indigo-600 mb-1">${escapeHtml(segment.song)}</p>` : ''}
                    ${segment.description ? `<p class="text-gray-700 text-sm">${escapeHtml(segment.description)}</p>` : ''}
                    ${subSegmentsHtml}
                </div>
            `;
        }).join('');

        // Show notes if present
        if (plan.notes) {
            document.getElementById('notes-section').classList.remove('hidden');
            document.getElementById('plan-notes').textContent = plan.notes;
        }
    }

    function formatTime(totalSeconds) {
        const minutes = Math.floor(totalSeconds / 60);
        const seconds = totalSeconds % 60;
        return `${minutes}:${seconds.toString().padStart(2, '0')}`;
    }

    function escapeHtml(text) {
        if (!text) return '';
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    loadPlan();
</script>
{% endblock %}
