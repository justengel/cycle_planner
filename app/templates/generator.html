{% extends "base.html" %}

{% block title %}Generate Lesson Plan - Cycle Planner{% endblock %}

{% block content %}
<div class="max-w-xl mx-auto">
    <div class="bg-white rounded-lg shadow-md p-6">
        <h2 class="text-2xl font-bold text-gray-800 mb-6">Create Lesson Plan</h2>

        <div class="flex flex-col sm:flex-row gap-3">
            <button
                onclick="createBlankPlan()"
                class="flex-1 bg-gray-100 text-gray-700 py-3 px-4 rounded-md hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2 font-medium"
            >
                Create Blank Plan
            </button>
            <a
                id="spotify-playlist-btn"
                href="/plan/from-playlist"
                class="hidden flex-1 bg-green-600 text-white py-3 px-4 rounded-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 font-medium flex items-center justify-center gap-2"
            >
                <svg class="w-5 h-5" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M12 0C5.4 0 0 5.4 0 12s5.4 12 12 12 12-5.4 12-12S18.66 0 12 0zm5.521 17.34c-.24.359-.66.48-1.021.24-2.82-1.74-6.36-2.101-10.561-1.141-.418.122-.779-.179-.899-.539-.12-.421.18-.78.54-.9 4.56-1.021 8.52-.6 11.64 1.32.42.18.479.659.301 1.02zm1.44-3.3c-.301.42-.841.6-1.262.3-3.239-1.98-8.159-2.58-11.939-1.38-.479.12-1.02-.12-1.14-.6-.12-.48.12-1.021.6-1.141C9.6 9.9 15 10.561 18.72 12.84c.361.181.54.78.241 1.2zm.12-3.36C15.24 8.4 8.82 8.16 5.16 9.301c-.6.179-1.2-.181-1.38-.721-.18-.601.18-1.2.72-1.381 4.26-1.26 11.28-1.02 15.721 1.621.539.3.719 1.02.419 1.56-.299.421-1.02.599-1.559.3z"/>
                </svg>
                From Spotify Playlist
            </a>
        </div>

        <div class="mt-4 mb-4 text-center">
            <span class="text-gray-400">or</span>
        </div>

        <form id="generate-form" class="space-y-6">
            <div>
                <label for="theme" class="block text-sm font-medium text-gray-700 mb-2">
                    Theme / Description
                </label>
                <textarea
                    id="theme"
                    name="theme"
                    rows="3"
                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500"
                    placeholder="e.g., 80s rock power ride, hill climb challenge, high energy pop hits, recovery and endurance..."
                    required
                ></textarea>
            </div>

            <div>
                <label for="duration" class="block text-sm font-medium text-gray-700 mb-2">
                    Duration: <span id="duration-display">50</span> minutes
                </label>
                <input
                    type="range"
                    id="duration"
                    name="duration_minutes"
                    min="20"
                    max="90"
                    value="50"
                    class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer"
                >
                <div class="flex justify-between text-xs text-gray-500 mt-1">
                    <span>20 min</span>
                    <span>90 min</span>
                </div>
            </div>

            <button
                type="submit"
                id="generate-btn"
                class="w-full bg-indigo-600 text-white py-3 px-4 rounded-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 font-medium"
            >
                Generate with AI
            </button>

            <div class="mt-4 p-3 bg-amber-50 border border-amber-200 rounded-md">
                <div class="flex gap-2">
                    <svg class="w-5 h-5 text-amber-500 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                    </svg>
                    <p class="text-sm text-amber-800">
                        <strong>Note:</strong> AI-generated song durations are estimates and may not be accurate.
                    </p>
                </div>
            </div>
        </form>

        <div id="loading" class="hidden mt-6 text-center">
            <div class="loader mx-auto mb-2"></div>
            <p class="text-gray-600">Generating your lesson plan...</p>
            <p class="text-gray-400 text-sm mt-1">This may take 10-20 seconds</p>
        </div>

        <div id="error" class="hidden mt-6 p-4 bg-red-100 text-red-700 rounded-md"></div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    const durationSlider = document.getElementById('duration');
    const durationDisplay = document.getElementById('duration-display');
    const form = document.getElementById('generate-form');
    const loadingDiv = document.getElementById('loading');
    const errorDiv = document.getElementById('error');
    const generateBtn = document.getElementById('generate-btn');

    // Check auth on page load (uses shared auth from base.html)
    async function checkAuth() {
        const data = await getAuthStatus();
        if (!data || !data.authenticated) {
            window.location.href = '/login';
        }
    }
    checkAuth();

    // Check Spotify connection and show playlist button if connected
    async function checkSpotifyConnection() {
        try {
            const response = await fetch('/api/spotify/token');
            const data = await response.json();
            if (data.connected) {
                document.getElementById('spotify-playlist-btn').classList.remove('hidden');
            }
        } catch (e) {
            // Not connected, button stays hidden
        }
    }
    checkSpotifyConnection();

    durationSlider.addEventListener('input', (e) => {
        durationDisplay.textContent = e.target.value;
    });

    form.addEventListener('submit', async (e) => {
        e.preventDefault();

        const theme = document.getElementById('theme').value;
        const duration = parseInt(durationSlider.value);

        // Show loading state
        loadingDiv.classList.remove('hidden');
        errorDiv.classList.add('hidden');
        generateBtn.disabled = true;
        generateBtn.textContent = 'Generating...';

        try {
            const response = await fetch('/api/generate', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    theme: theme,
                    duration_minutes: duration
                })
            });

            if (!response.ok) {
                const data = await response.json();
                throw new Error(data.detail || 'Failed to generate lesson plan');
            }

            const data = await response.json();

            // Redirect to edit page so user can link Spotify songs
            if (data.id) {
                // Mark that this is a freshly generated plan needing Spotify setup
                sessionStorage.setItem('showSpotifyPrompt', 'true');
                window.location.href = `/plan/${data.id}/edit`;
            } else {
                sessionStorage.setItem('generatedPlan', JSON.stringify(data.plan));
                sessionStorage.setItem('showSpotifyPrompt', 'true');
                window.location.href = '/plan/new';
            }

        } catch (error) {
            errorDiv.textContent = error.message;
            errorDiv.classList.remove('hidden');
            loadingDiv.classList.add('hidden');
            generateBtn.disabled = false;
            generateBtn.textContent = 'Generate with AI';
        }
    });

    function createBlankPlan() {
        const theme = document.getElementById('theme').value || 'New Lesson Plan';
        const duration = parseInt(durationSlider.value);

        const blankPlan = {
            theme: theme,
            total_duration_minutes: duration,
            segments: [
                {
                    name: 'Warm-up',
                    duration_seconds: 300,
                    intensity: 'low',
                    position: 'seated',
                    description: '',
                    suggested_bpm_range: '80-100',
                    song: ''
                },
                {
                    name: 'Main Set',
                    duration_seconds: 600,
                    intensity: 'medium',
                    position: 'seated',
                    description: '',
                    suggested_bpm_range: '100-120',
                    song: ''
                },
                {
                    name: 'Cool-down',
                    duration_seconds: 300,
                    intensity: 'low',
                    position: 'seated',
                    description: '',
                    suggested_bpm_range: '80-100',
                    song: ''
                }
            ],
            notes: null
        };

        sessionStorage.setItem('generatedPlan', JSON.stringify(blankPlan));
        window.location.href = '/plan/new';
    }
</script>
{% endblock %}
